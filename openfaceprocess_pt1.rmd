---
title: 'OpenFace Process Pt1'
author: "Julianna Calabrese"
date: "2/19/2021"
output: html_document
editor_options: 
  chunk_output_type: console
---

# PART 1 of 2

# Introduction

The goal of this document is to turn the .csv files generated by OpenFace into one dataframe that can be reasonably analyzed. At this point, all of the individual .csv files exist in a folder on the server. The videos have already been analyzed by OpenFace. Previous to this step, I have already ran an .rmd file on the Linux computing server to make the .csv files smaller. OpenFace generates a lot of information and columns on head position and eye gaze, which we are  not interested in. The .csv files currently on the server are these 'smaller' .csv files. 

Timeline of the process:

* Download OpenFace on the Linux computing server
* Put the videos on the Linux computing server
* Analyze the videos using OpenFace and save the processed output to the shared /data folder
* Move only the processed csv files to a folder called csv within /data
* Run the RScript `openfacecleanup.R` on the Linux server
  + This makes the csv file 'smaller', only keeping variables we're interested in
  + This was needed to make computing time manageable
  + All of the smaller csv folders are saved to a folder called small under /data
* Manually move the small folder to the server

Right after this, run `openfaceprocess_pt2.rmd`. There are two separate process files because when I tried to run them together, it took three hours and then RStudio crashed. It's much easier to troubleshoot if they're separate files.

```{r}
# How long will this file take?
Sys.time()
start.time <- Sys.time()
```

# Load in packages

```{r}
library(dplyr)
library(tidyverse)
library(lessR)
library(purrr)
library(reshape2)
library(panelr)
library(data.table)
library(haven)
library(foreign)
library(foreach)
library(zoo)
library(stringr)
```

# STEP 1: Read in data

## Read in OpenFace csv files

I'm reading in all the csv files as a list, rather than individual dataframes, because StackOverflow told me that individually loading in 878 dataframes was a bad idea. 

```{r}
# Set directory
setwd("~/firstyearproject/csv")

# Read in file as a list
filelist <- list.files(pattern="*.csv", full.names=TRUE)

lst <- lapply(filelist, read.csv, header=TRUE, stringsAsFactors=FALSE)

# print(filelist)
# Why do 143 and 165 have extra hyphens in their names?
# I need to fix that
filelist <- gsub("-", "", as.list(filelist))

names(lst) <- filelist

# File names also all have this weird prefix, this fixes the names
names(lst) <- substring(names(lst), 3)
filelist <- substring(filelist, 3)
filelist <- substr(filelist,1,nchar(filelist)-4)
```

## Read in data on recording side

Recording side tells us which side the mother is on; sometimes on the left, sometimes on the right. 

```{r}
setwd("~/firstyearproject")

recording_side <- read.csv("/firstyearproject/recording_side.csv")

# recording_side includes 135, but not 165 or 143...
print(recording_side$clipID)

# remove clipID 135 because 135 doesn't have matching mother/daughter sides
recording_side <- filter(recording_side, clipID != "135")
```

## Create variables based on dataframe names

Information concerning ID and side is only in the name of the dataframe within this big list -- we need to extract that and make it a column in each dataframe.

### Create clipID

The clipID variable is for dyads -- a mother and daughter who are part of the same dyad will have the same variable.

```{r}
# Create clipID
namelist <- substr(filelist, 1, 3)
lst <- mapply(cbind, lst, "clipID"=namelist, SIMPLIFY=F)
```

### Create side

```{r}
# Create side
videolist <- substr(filelist, 14, 18)
lst <- mapply(cbind, lst, "side"=videolist, SIMPLIFY=F)
```

### Create order

This is needed because the DVD'ing process that occurred long ago split up videos into smaller bits. The order variables helps us keep track of the chronological order of the video bits within the whole interaction task. 

```{r}
# Create order
orderlist <- substr(filelist, 12, 12)
lst <- mapply(cbind, lst, "order"=orderlist, SIMPLIFY=F)
```

### Clean up

```{r}
rm(filelist)
rm(namelist)
rm(orderlist)
rm(videolist)
```

# STEP 2: Make it long

## Merge them all together so that they become long

```{r}
# Merge!
lst2 <- lst %>% reduce(rbind, by = c("clipID", "side", "order"))
# This might take a long time, like ~40 minutes

rm(lst)

#lst2backup <- lst2
```

## Remove annoying clipIDs

After I do this 40-minute thing with `lst2`, it creates a new clipID called 'side'. Also, I want to eliminate clipID 135, 143, and 165. 135 has mismatching mother/daughter sides, and 143 and 165 are not included in recording_side.

```{r}
# Are there any NA values?
colSums(is.na(lst2))

# How many IDs are there?
length(unique(lst2$clipID))

# Look at clipIDs
print(unique(lst2$clipID))
# Okay, so there's actually 51 sides

lst2 <- filter(lst2, clipID != "side" & 
                 clipID != "135" &
                 clipID != "143" &
                 clipID != "165")

# I have to remove 135 because it doesn't have matching mother/daughter sides
# I have to remove 143 and 165 because they aren't included in recording_side

# Look at clipIDs again
print(unique(lst2$clipID))

# Are there any NA values?
colSums(is.na(lst2))

# How many IDs are there?
length(unique(lst2$clipID))
```

# STEP 3: Make it wide 

This makes the data wide using the side variable.

```{r}
lst3 <- lst2 %>%
  group_by(side, clipID) %>%
  mutate(row =row_number()) %>%
  select(-clipID) %>%
  tidyr::pivot_wider(names_from = side, values_from = frame:AU45_c) %>%
  select(-row)

# Are there any NA values?
colSums(is.na(lst3))

# How many IDs are there?
length(unique(lst3$clipID))

# Look at clipIDs
print(unique(lst3$clipID))

# What kind of class is lst3?
class(lst3) 
```

# STEP 4: Turn it into a dataframe

```{r}
lst4 <- as.data.frame(lst3)

# Make sure it's a dataframe
class(lst4)

# Are there any NA values?
colSums(is.na(lst4))

# How many IDs are there?
length(unique(lst4$clipID))

# Look at clipIDs
print(unique(lst4$clipID))
```

# STEP 5: Merge with recording side

```{r}
# Merge with recording side
lst5 <- merge(lst4, recording_side, by="clipID", all.x=TRUE)

# Are there any NA values?
colSums(is.na(lst5))

# How many IDs are there?
length(unique(lst5$clipID))

# Look at clipIDs
print(unique(lst5$clipID))
```

# Write it out

```{r}
write.csv(lst5, "~/firstyearproject/openfaceprocess_pt1.csv", row.names=FALSE)
```

```{r}
end.time <- Sys.time()
time.taken <- end.time - start.time
time.taken # Should take about 50 minutes
```

```{r}
# Clean up
rm(list=ls())
```
